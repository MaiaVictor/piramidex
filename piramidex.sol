// address: 0x1317b58f6e0126f65969c953551b784b06633b1a
// bytecode: 0x6060604052341561000f57600080fd5b610ad38061001e6000396000f3006060604052600436106100c5576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063029f1d0e146100ca5780634177bf901461010957806383b658bf146101495780638b7afe2e146101ac578063ae3edb65146101d5578063d4ddce8a146101fc578063d6febde814610233578063d79875eb14610254578063d92fc67b14610280578063da374e2a146102a9578063e1fa8e84146102e0578063e725f87714610307578063eab11db114610346575b600080fd5b34156100d557600080fd5b6100eb600480803590602001909190505061036f565b60405180826000191660001916815260200191505060405180910390f35b341561011457600080fd5b6101336004808035906020019091908035906020019091905050610398565b6040518082815260200191505060405180910390f35b341561015457600080fd5b61016a60048080359060200190919050506103d3565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34156101b757600080fd5b6101bf61041c565b6040518082815260200191505060405180910390f35b34156101e057600080fd5b6101fa60048080356000191690602001909190505061043b565b005b341561020757600080fd5b61021d60048080359060200190919050506104b6565b6040518082815260200191505060405180910390f35b61025260048080359060200190919080359060200190919050506104e0565b005b341561025f57600080fd5b61027e60048080359060200190919080359060200190919050506106b4565b005b341561028b57600080fd5b61029361089c565b6040518082815260200191505060405180910390f35b34156102b457600080fd5b6102ca60048080359060200190919050506108a9565b6040518082815260200191505060405180910390f35b34156102eb57600080fd5b6103056004808035600019169060200190919050506108d3565b005b341561031257600080fd5b6103286004808035906020019091905050610988565b60405180826000191660001916815260200191505060405180910390f35b341561035157600080fd5b6103596109b2565b6040518082815260200191505060405180910390f35b6000808281548110151561037f57fe5b9060005260206000209060030201600001549050919050565b600080838154811015156103a857fe5b9060005260206000209060030201600201600083815260200190815260200160002054905092915050565b600080828154811015156103e357fe5b906000526020600020906003020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b60003073ffffffffffffffffffffffffffffffffffffffff1631905090565b6001805480600101828161044f91906109be565b916000526020600020906003020160006060604051908101604052808560001916815260200160008152602001662386f26fc10000815250909190915060008201518160000190600019169055602082015181600101556040820151816002015550505050565b60006001828154811015156104c757fe5b9060005260206000209060030201600201549050919050565b600080805490508310158061056157503373ffffffffffffffffffffffffffffffffffffffff1660008481548110151561051657fe5b906000526020600020906003020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614155b8061057157506001805490508210155b8061059b57503460018381548110151561058757fe5b906000526020600020906003020160020154115b156105a557600080fd5b6001828154811015156105b457fe5b90600052602060002090600302016002015490506001828154811015156105d757fe5b90600052602060002090600302016001016000815480929190600101919050555060008381548110151561060757fe5b9060005260206000209060030201600201600083815260200190815260200160002060008154809291906001019190505550600a600b820281151561064857fe5b0460018381548110151561065857fe5b9060005260206000209060030201600201819055503373ffffffffffffffffffffffffffffffffffffffff166108fc8234039081150290604051600060405180830381858888f1935050505015156106af57600080fd5b505050565b600080805490508310158061073557503373ffffffffffffffffffffffffffffffffffffffff166000848154811015156106ea57fe5b906000526020600020906003020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614155b8061074557506001805490508210155b806107815750600160008481548110151561075c57fe5b9060005260206000209060030201600201600084815260200190815260200160002054105b1561078b57600080fd5b600b600a6001808581548110151561079f57fe5b90600052602060002090600302016002015401028115156107bc57fe5b0490506001828154811015156107ce57fe5b906000526020600020906003020160010160008154809291906001900391905055506000838154811015156107ff57fe5b9060005260206000209060030201600201600083815260200190815260200160002060008154809291906001900391905055508060018381548110151561084257fe5b9060005260206000209060030201600201819055503373ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f19350505050151561089757600080fd5b505050565b6000600180549050905090565b60006001828154811015156108ba57fe5b9060005260206000209060030201600101549050919050565b600080548060010182816108e791906109f0565b916000526020600020906003020160006040805190810160405280856000191681526020013373ffffffffffffffffffffffffffffffffffffffff1681525090919091506000820151816000019060001916905560208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050505050565b600060018281548110151561099957fe5b9060005260206000209060030201600001549050919050565b60008080549050905090565b8154818355818115116109eb576003028160030283600052602060002091820191016109ea9190610a22565b5b505050565b815481835581811511610a1d57600302816003028360005260206000209182019101610a1c9190610a59565b5b505050565b610a5691905b80821115610a52576000808201600090556001820160009055600282016000905550600301610a28565b5090565b90565b610aa491905b80821115610aa0576000808201600090556001820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905550600301610a5f565b5090565b905600a165627a7a72305820e752497b5aca39eba97607679709370ef50f7d5ff5dfba31de19169245b081660029
// abi: [{"constant":true,"inputs":[{"name":"userId","type":"uint256"}],"name":"userName","outputs":[{"name":"","type":"bytes32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"userId","type":"uint256"},{"name":"tokenId","type":"uint256"}],"name":"userTokenCount","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"userId","type":"uint256"}],"name":"userAddr","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"contractBalance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"name","type":"bytes32"}],"name":"createToken","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"tokenId","type":"uint256"}],"name":"tokenPrice","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"userId","type":"uint256"},{"name":"tokenId","type":"uint256"}],"name":"buy","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"userId","type":"uint256"},{"name":"tokenId","type":"uint256"}],"name":"sell","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"tokensLength","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"tokenId","type":"uint256"}],"name":"tokenCount","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"name","type":"bytes32"}],"name":"register","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"tokenId","type":"uint256"}],"name":"tokenName","outputs":[{"name":"","type":"bytes32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"usersLength","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]

pragma solidity ^0.4.20;

contract Piramidex {

  struct User {
    bytes32 name;
    address addr;
    mapping (uint256 => uint256) tokenCount;
  }

  struct Token {
    bytes32 name;
    uint256 count;
    uint256 price;
  }

  User[] users;
  Token[] tokens;
  
  function Piramidex() public {}

  // Registers yourself as a Piramidex user
  function register
    ( bytes32 name
    ) public {
    users.push(User({
      name: name,
      addr: msg.sender
    }));
  }

  // Creates a new token
  function createToken
    ( bytes32 name
    ) public {
    tokens.push(Token({
      name: name,
      count: 0,
      price: 10000000000000000
    }));
  }

  // User buys a token for Ether
  function buy
    ( uint256 userId
    , uint256 tokenId
    ) public payable {
      
    // User must exist and have at least 1 token
    if ( userId >= users.length
      || users[userId].addr != msg.sender
      || tokenId >= tokens.length
      || tokens[tokenId].price > msg.value)
      revert();

    // Updates token price, user data and sends change
    uint256 buyPrice = tokens[tokenId].price;
    tokens[tokenId].count++;
    users[userId].tokenCount[tokenId]++;
    tokens[tokenId].price = buyPrice * 11 / 10; 
    msg.sender.transfer(msg.value - buyPrice);
  }

  // User sells a token, receives Ether
  function sell
    ( uint256 userId
    , uint256 tokenId
    ) public {

    
    // User must exist and have at least 1 token
    if ( userId >= users.length
      || users[userId].addr != msg.sender
      || tokenId >= tokens.length
      || users[userId].tokenCount[tokenId] < 1)
      revert();

    // Updates token price, user data and sends Ether
    uint256 sellPrice = (tokens[tokenId].price + 1) * 10 / 11;
    tokens[tokenId].count--;
    users[userId].tokenCount[tokenId]--;
    tokens[tokenId].price = sellPrice; 
    msg.sender.transfer(sellPrice);
  }

  // Queries

  function usersLength() public constant returns (uint256) {
    return users.length;
  }

  function userName(uint256 userId) public constant returns (bytes32) {
    return users[userId].name;
  }

  function userAddr(uint256 userId) public constant returns (address) {
    return users[userId].addr;
  }

  function userTokenCount(uint256 userId, uint256 tokenId) public constant returns (uint256) {
    return users[userId].tokenCount[tokenId];
  }

  function tokensLength() public constant returns (uint256) {
    return tokens.length;
  }

  function tokenName(uint256 tokenId) public constant returns (bytes32) { 
    return tokens[tokenId].name;
  }

  function tokenCount(uint256 tokenId) public constant returns (uint256) {
    return tokens[tokenId].count;
  }
  
  function tokenPrice(uint256 tokenId) public constant returns (uint256) {
    return tokens[tokenId].price;
  }

  function contractBalance() public constant returns (uint256) {
    return this.balance;
  }

}
